<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cotizador — Uso interno MCB</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#0b0f1a;color:#e5e7eb;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:1rem}
    .input,select{background:#0b1220;border:1px solid #243042;border-radius:.6rem;padding:.6rem .75rem;color:#e5e7eb}
    .btn{background:#111827;border:1px solid #2b3445;border-radius:.75rem;padding:.6rem 1rem}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .money{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <div class="max-w-3xl mx-auto p-4">
    <header class="mb-4">
      <h1 class="text-2xl font-semibold">Cotizador — Uso interno MCB</h1>
      <p class="text-slate-400">Selecciona empresa, (plan si aplica), género y edad; luego pulsa “Consultar”.</p>
    </header>

    <section class="card grid md:grid-cols-5 gap-4 mb-4">
      <div class="md:col-span-1">
        <label class="text-sm text-slate-300">Empresa</label>
        <select id="cliente" class="input w-full">
          <option value="BIMBO">BIMBO</option>
          <option value="STRM">STRM</option>
        </select>
      </div>
      <div class="md:col-span-1" id="plan-wrap" style="display:none">
        <label class="text-sm text-slate-300">Plan (STRM)</label>
        <select id="plan" class="input w-full">
          <option value="Plan600">Tarifa Plan 600</option>
          <option value="OtrosPlanes">Tarifa Otros Planes</option>
        </select>
      </div>
      <div class="md:col-span-1">
        <label class="text-sm text-slate-300">Género</label>
        <select id="genero" class="input w-full">
          <option value="H">Hombre</option>
          <option value="M">Mujer</option>
        </select>
      </div>
      <div class="md:col-span-1">
        <label class="text-sm text-slate-300">Edad</label>
        <input id="edad" type="number" min="0" max="120" value="25" class="input w-full"/>
      </div>
      <div class="md:col-span-1 flex items-end">
        <button id="btn-consultar" class="btn w-full">Consultar</button>
      </div>
    </section>

    <section class="card">
      <div class="text-sm space-y-2">
        <div class="flex justify-between text-xl"><span>Total anual</span><strong id="total" class="money">—</strong></div>
        <div class="flex justify-between"><span>Prima mensual (total/12)</span><strong id="mensual" class="money">—</strong></div>
      </div>
      <p id="status" class="text-xs text-amber-300 mt-3 hidden"></p>
    </section>
  </div>

  <script>
    // Mapeo con rutas alternativas: intenta cada una hasta que cargue
    const JSON_CANDIDATES = {
      BIMBO: ['data/pricing-bimbo.json', 'pricing-bimbo.json', './pricing-bimbo.json'],
      STRM:  ['data/pricing-strm.json',  'pricing-strm.json',  './pricing-strm.json']
    };

    const $ = s => document.querySelector(s);
    const formatMoney = (v) => new Intl.NumberFormat('es-MX', {style:'currency', currency:'MXN'}).format(Number(v||0));

    function rangoDeEdad(edad) {
      if (edad >= 80) return '80-mas';
      const low = Math.floor(edad / 5) * 5;
      const high = Math.min(low + 4, 79);
      const a = String(low).padStart(2,'0');
      const b = String(high).padStart(2,'0');
      return `${a}-${b}`;
    }

    async function fetchFirst(urls) {
      let lastErr;
      for (const url of urls) {
        try {
          const res = await fetch(url, { cache: 'no-cache' });
          if (res.ok) return await res.json();
          lastErr = new Error('HTTP ' + res.status + ' en ' + url);
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('No se pudo cargar ningún JSON de tarifas');
    }

    async function loadJSON(cliente) {
      const candidates = JSON_CANDIDATES[cliente];
      if (!candidates) throw new Error('Cliente no soportado');
      return await fetchFirst(candidates);
    }

    function calcularBimbo(pricing, genero, edad) {
      const r = rangoDeEdad(edad);
      const fila = pricing.tarifas.find(t => t.rango === r);
      if (!fila) throw new Error('No hay tarifa para el rango ' + r);
      const valor = genero === 'M' ? fila.M : fila.H;
      if (typeof valor !== 'number') throw new Error('Tarifa inválida en ' + r);
      const dec = pricing?.reglas?.redondeo ?? 2;
      const total = Number(valor.toFixed(dec));
      const mensual = Number((total / 12).toFixed(dec));
      return { total, mensual };
    }

    function calcularStrm(pricing, plan, genero, edad) {
      const r = rangoDeEdad(edad);
      const tabla = pricing?.planes?.[plan];
      if (!Array.isArray(tabla)) throw new Error('Plan inválido para STRM');
      const fila = tabla.find(t => t.rango === r);
      if (!fila) throw new Error('No hay tarifa para el rango ' + r + ' en ' + plan);
      const valor = genero === 'M' ? fila.M : fila.H;
      if (typeof valor !== 'number') throw new Error('Tarifa inválida en ' + r);
      const dec = pricing?.reglas?.redondeo ?? 2;
      const total = Number(valor.toFixed(dec));
      const mensual = Number((total / 12).toFixed(dec));
      return { total, mensual };
    }

    function togglePlan() {
      const isStrm = $('#cliente').value === 'STRM';
      $('#plan-wrap').style.display = isStrm ? '' : 'none';
    }

    async function consultar() {
      const btn = $('#btn-consultar'); btn.disabled = true;
      $('#status').classList.add('hidden');
      try {
        const cliente = $('#cliente').value;
        const genero  = $('#genero').value;
        const edad    = Number($('#edad').value)||0;
        const pricing = await loadJSON(cliente);
        let result;
        if (cliente === 'BIMBO') {
          result = calcularBimbo(pricing, genero, edad);
        } else { // STRM
          const plan = $('#plan').value;
          result = calcularStrm(pricing, plan, genero, edad);
        }
        $('#total').textContent = formatMoney(result.total);
        $('#mensual').textContent = formatMoney(result.mensual);
      } catch (e) {
        $('#status').textContent = e.message;
        $('#status').classList.remove('hidden');
        $('#total').textContent = '—';
        $('#mensual').textContent = '—';
      } finally {
        btn.disabled = false;
      }
    }

    // init
    togglePlan();
    $('#cliente').addEventListener('change', togglePlan);
    $('#btn-consultar').addEventListener('click', consultar);
  </script>
</body>
</html>
