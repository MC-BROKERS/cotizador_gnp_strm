<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cotizador — GNP Salud</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --mcb-blue:#0057A4;   /* primario */
      --mcb-green:#2FA24A;  /* acento */
      --mcb-lime:#9CCB3B;   /* badge */
      --ink:#1F2937;        /* texto principal */
      --muted:#6B7280;      /* texto secundario */
      --stroke:#E5E7EB;     /* bordes */
      --surface:#ffffff;    /* tarjetas */
      --bg:#ffffff;         /* fondo */
    }
    body{background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto}
    .container{max-width:900px}
    .card{background:var(--surface);border:1px solid var(--stroke);border-radius:16px;padding:1rem}
    .input,select{background:#fff;border:1px solid #D1D5DB;border-radius:.7rem;padding:.7rem .85rem;color:var(--ink)}
    .input:focus,select:focus{outline:3px solid color-mix(in oklab, var(--mcb-blue) 25%, white);outline-offset:2px}
    .btn{background:var(--mcb-blue);border:1px solid #044b8f;border-radius:.9rem;padding:.75rem 1.15rem;color:#fff;font-weight:600}
    .btn:hover{filter:brightness(1.06)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .label{font-size:.85rem;color:#374151}
    .money{font-variant-numeric:tabular-nums}
    .kpi{background:#F7FAFF;border:1px solid #DCEBFF;border-radius:14px;padding:.95rem}
    .accent{color:var(--mcb-green)}
    header .brand{display:flex;align-items:center;gap:14px}
    header img{height:112px}         /* 200% del tamaño que tenías (antes ~56px) */
    header h1{line-height:1}
    .subtle{color:var(--muted)}

    /* Destacar “Prima Total Anual” */
    .primary-row {align-items:baseline}
    .primary-label {font-size:1.05rem;font-weight:600;color:#0f172a}
    .primary-amount {font-size:1.6rem;font-weight:800;color:var(--mcb-blue)}
    .badge {
      background: var(--mcb-lime);
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0.2rem 0.6rem;
      border-radius: 9999px; /* pill */
      line-height: 1;
    }
  </style>
</head>
<body>
  <div class="container mx-auto p-4">
    <header class="mb-5">
      <div class="brand">
        <img src="Logo_Colores_MCB.png" alt="MCBrokers" />
        <div>
          <h1 class="text-2xl font-semibold">Cotizador — GNP Salud</h1>
          <p class="subtle text-sm">Cotización interna con tarifas STRM y BIMBO</p>
        </div>
      </div>
      <hr class="mt-4 border-gray-200"/>
    </header>

    <!-- Fila 1: Empresa + Producto (solo STRM) + Plan (solo STRM) -->
    <section class="card grid md:grid-cols-3 gap-4 mb-3">
      <div>
        <label class="label">Empresa</label>
        <select id="cliente" class="input w-full">
          <option value="BIMBO">BIMBO</option>
          <option value="STRM">STRM</option>
        </select>
      </div>
      <div id="producto-wrap" style="display:none">
        <label class="label">Producto (STRM)</label>
        <select id="producto" class="input w-full">
          <option value="LINEA_AZUL">Línea Azul</option>
          <option value="EXCESOS">Excesos</option>
        </select>
      </div>
      <div id="plan-wrap" style="display:none">
        <label class="label">Plan (STRM)</label>
        <select id="plan" class="input w-full">
          <option value="Plan600">Tarifa Plan 600</option>
          <option value="OtrosPlanes">Tarifa Otros Planes</option>
        </select>
      </div>
    </section>

    <!-- Fila 2: Género + Edad -->
    <section class="card grid md:grid-cols-3 gap-4 mb-3">
      <div>
        <label class="label">Género</label>
        <select id="genero" class="input w-full">
          <option value="H">Hombre</option>
          <option value="M">Mujer</option>
        </select>
      </div>
      <div>
        <label class="label">Edad</label>
        <input id="edad" type="number" min="0" max="120" value="25" class="input w-full"/>
      </div>
      <div class="hidden md:block"></div>
    </section>

    <!-- Fila 3: Botón Consultar -->
    <section class="card mb-4">
      <button id="btn-consultar" class="btn">Consultar</button>
      <p id="status" class="text-xs text-red-600 mt-2 hidden"></p>
    </section>

    <!-- Resultado -->
    <section class="grid gap-4">
      <div class="kpi">
        <div class="flex justify-between primary-row">
          <span class="primary-label">Prima Total Anual</span>
          <div class="flex items-center gap-2">
            <strong id="total" class="money primary-amount">—</strong>
            <span class="badge" id="badge-total">TOTAL</span>
          </div>
        </div>
        <div class="flex justify-between mt-1">
          <span>Prima Mensual</span><strong id="mensual" class="money">—</strong>
        </div>
        <div id="row-semanal" class="flex justify-between mt-1" style="display:none">
          <span>Prima Semanal <span class="subtle">(anual/48)</span></span>
          <strong id="semanal" class="money">—</strong>
        </div>
        <div id="row-catorcenal" class="flex justify-between mt-1" style="display:none">
          <span>Prima Catorcenal <span class="subtle">(anual/24)</span></span>
          <strong id="catorcenal" class="money">—</strong>
        </div>
      </div>

      <div id="meses-wrap" class="card" style="display:none">
        <div class="grid md:grid-cols-3 gap-4 items-end">
          <div>
            <label class="label">Meses de cobertura</label>
            <select id="meses" class="input w-full"></select>
          </div>
          <div class="md:col-span-2 kpi">
            <div class="flex justify-between">
              <span>Total para <span id="meses-label" class="accent">—</span> mes(es)</span>
              <strong id="total-meses" class="money">—</strong>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // JSON en la misma carpeta que index.html
    const JSON_PATH = {
      BIMBO: 'pricing-bimbo.json',
      STRM_LINEA_AZUL: 'pricing-strm.json',
      STRM_EXCESOS: 'pricing-strm-excesos.json'
    };

    const $ = s => document.querySelector(s);
    const formatMoney = (v) =>
      new Intl.NumberFormat('es-MX', {style:'currency', currency:'MXN'}).format(Number(v||0));

    function rangoDeEdad(edad) {
      edad = Number(edad || 0);
      if (edad < 0) edad = 0;
    
      if (edad <= 4) return '00-04';       // primer bloque
      if (edad <= 14) return '05-14';      // bloque especial unido
      if (edad >= 80) return '80-mas';     // último bloque abierto
    
      // a partir de 15 va en bloques de 5: 15-19, 20-24, …, 75-79
      const start = Math.floor((edad - 15) / 5) * 5 + 15;
      const end = Math.min(start + 4, 79);
      return `${String(start).padStart(2, '0')}-${String(end).padStart(2, '0')}`;
    }

    async function loadJSON(cliente, producto) {
      let key;
      if (cliente === 'BIMBO') {
        key = 'BIMBO';
      } else if (cliente === 'STRM') {
        key = producto === 'EXCESOS' ? 'STRM_EXCESOS' : 'STRM_LINEA_AZUL';
      }
      const url = JSON_PATH[key];
      const res = await fetch(url, { cache: 'no-cache' });
      if (!res.ok) throw new Error('No se pudo cargar tarifas de ' + cliente);
      return await res.json();
    }

    function calcularBimbo(pricing, genero, edad) {
      const r = rangoDeEdad(edad);
      const fila = pricing.tarifas.find(t => t.rango === r);
      if (!fila) throw new Error('No hay tarifa para el rango ' + r);
      const valor = genero === 'M' ? fila.M : fila.H;
      const dec = pricing?.reglas?.redondeo ?? 2;
      const total = Number(valor.toFixed(dec));
      const mensual = Number((total / 12).toFixed(dec));
      const semanal = Number((total / 48).toFixed(dec));
      const catorcenal = Number((total / 24).toFixed(dec));
      return { total, mensual, semanal, catorcenal };
    }

    function calcularStrm(pricing, plan, genero, edad) {
      const r = rangoDeEdad(edad);
      const tabla = pricing?.planes?.[plan];
      if (!Array.isArray(tabla)) throw new Error('Plan inválido para STRM');
      const fila = tabla.find(t => t.rango === r);
      if (!fila) throw new Error('No hay tarifa para el rango ' + r);
      const valor = genero === 'M' ? fila.M : fila.H;
      const dec = pricing?.reglas?.redondeo ?? 2;
      const total = Number(valor.toFixed(dec));
      const mensual = Number((total / 12).toFixed(dec));
      const semanal = Number((total / 48).toFixed(dec));
      return { total, mensual, semanal };
    }

    function toggleProductoYPlan() {
      const isSTRM = $('#cliente').value === 'STRM';
      $('#producto-wrap').style.display = isSTRM ? '' : 'none';
      $('#plan-wrap').style.display = isSTRM ? '' : 'none';
    }

    function buildMesesSelect() {
      const sel = $('#meses'); sel.innerHTML = '';
      for (let i=1;i<=12;i++) {
        const opt = document.createElement('option');
        opt.value = String(i); opt.textContent = String(i);
        sel.appendChild(opt);
      }
    }

    function actualizarMeses(mensual) {
      const meses = Number($('#meses').value||'1');
      $('#meses-label').textContent = meses;
      const total = Number((mensual * meses).toFixed(2));
      $('#total-meses').textContent = formatMoney(total);
    }

    async function consultar() {
      const btn = $('#btn-consultar'); btn.disabled = true;
      $('#status').classList.add('hidden');
      try {
        const cliente = $('#cliente').value;
        const producto = $('#producto').value;
        const genero  = $('#genero').value;
        const edad    = Number($('#edad').value)||0;
        const pricing = await loadJSON(cliente, producto);
        let r;
        // Mostrar badge dinámico por cliente si lo quieres (descomenta la línea siguiente):
        // $('#badge-total').textContent = 'TOTAL ' + cliente;

        if (cliente === 'BIMBO') {
          r = calcularBimbo(pricing, genero, edad);
          $('#row-semanal').style.display = '';
          $('#row-catorcenal').style.display = '';
          $('#semanal').textContent = formatMoney(r.semanal);
          $('#catorcenal').textContent = formatMoney(r.catorcenal);
        } else {
          const plan = $('#plan').value;
          r = calcularStrm(pricing, plan, genero, edad);
          $('#row-semanal').style.display = '';
          $('#row-catorcenal').style.display = 'none';
          $('#semanal').textContent = formatMoney(r.semanal);
          $('#catorcenal').textContent = '—';
        }

        $('#total').textContent = formatMoney(r.total);
        $('#mensual').textContent = formatMoney(r.mensual);

        // meses de cobertura
        buildMesesSelect();
        $('#meses-wrap').style.display = '';
        $('#meses').value = '12';
        actualizarMeses(r.mensual);
        $('#meses').onchange = () => actualizarMeses(r.mensual);
      } catch (e) {
        $('#status').textContent = e.message;
        $('#status').classList.remove('hidden');
        $('#total').textContent = '—';
        $('#mensual').textContent = '—';
        $('#row-semanal').style.display = 'none';
        $('#row-catorcenal').style.display = 'none';
        $('#meses-wrap').style.display = 'none';
      } finally {
        btn.disabled = false;
      }
    }

    toggleProductoYPlan();
    $('#cliente').addEventListener('change', toggleProductoYPlan);
    $('#btn-consultar').addEventListener('click', consultar);
  </script>
</body>
</html>
