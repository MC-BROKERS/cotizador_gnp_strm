<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cotizador ‚Äî Multicliente (STRM / BIMBO)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--ring:#2563eb}
    body{background:#0b0f1a;color:#e5e7eb;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:1rem}
    .input,select{background:#0b1220;border:1px solid #243042;border-radius:.6rem;padding:.6rem .75rem;color:#e5e7eb}
    .btn{background:#111827;border:1px solid #2b3445;border-radius:.75rem;padding:.6rem 1rem}
    .btn:focus{outline:2px solid var(--ring)}
    .money{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <div class="max-w-4xl mx-auto p-4">
    <header class="mb-4">
      <h1 class="text-2xl font-semibold">üßÆ Cotizador ‚Äî Multicliente</h1>
      <p class="text-slate-400">Soporta STRM y BIMBO mediante archivos JSON externos versionados.</p>
    </header>

    <section class="card mb-4 grid md:grid-cols-3 gap-4">
      <div>
        <label class="text-sm text-slate-300">Cliente</label>
        <select id="cliente" class="input w-full">
          <option value="BIMBO">BIMBO</option>
          <option value="STRM">STRM</option>
        </select>
        <p id="cliente-hint" class="text-xs text-amber-300 mt-1 hidden"></p>
      </div>
      <div>
        <label class="text-sm text-slate-300">G√©nero</label>
        <select id="genero" class="input w-full">
          <option value="H">Hombre</option>
          <option value="M">Mujer</option>
        </select>
      </div>
      <div>
        <label class="text-sm text-slate-300">Edad</label>
        <input id="edad" type="number" min="0" max="120" value="25" class="input w-full"/>
      </div>
    </section>

    <section class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2 card">
        <h2 class="font-semibold">Detalle</h2>
        <div class="mt-3 text-sm space-y-2">
          <div class="flex justify-between"><span>Rango</span><strong id="rango"></strong></div>
          <div class="flex justify-between"><span>Tarifa base</span><strong id="tarifa" class="money">$0.00</strong></div>
          <div class="flex justify-between"><span>IVA (16%)</span><strong id="iva" class="money">$0.00</strong></div>
          <hr class="my-2 border-slate-700"/>
          <div class="flex justify-between text-xl"><span>Total</span><strong id="total" class="money">$0.00</strong></div>
        </div>
      </div>

      <aside class="card">
        <h2 class="font-semibold">Acciones</h2>
        <div class="mt-3 grid gap-2">
          <button id="btn-compartir" class="btn">üîó Compartir</button>
          <button id="btn-pdf" class="btn">üñ®Ô∏è Imprimir/Guardar PDF</button>
        </div>
      </aside>
    </section>

    <section class="card mt-4">
      <details>
        <summary class="cursor-pointer">üì¶ Fuente de tarifas</summary>
        <pre id="meta" class="text-xs overflow-auto bg-[#0b1220] p-3 rounded"></pre>
      </details>
    </section>
  </div>

  <script>
    const JSON_MAP = {
      'BIMBO': 'pricing-bimbo.json',
      'STRM':  'pricing-strm.json' // plantilla; rellenar con tarifas reales
    };

    const $ = s => document.querySelector(s);
    const formatMoney = (v) => new Intl.NumberFormat('es-MX', {style:'currency', currency:'MXN'}).format(Number(v||0));

    function rangoDeEdad(edad) {
      if (edad >= 80) return '80-mas';
      const low = Math.floor(edad / 5) * 5;
      const high = Math.min(low + 4, 79);
      const a = String(low).padStart(2,'0');
      const b = String(high).padStart(2,'0');
      return `${a}-${b}`;
    }

    async function loadPricing(cliente) {
      const url = JSON_MAP[cliente];
      if (!url) throw new Error('Cliente no soportado');

      // cache local
      const key = `pricing:${cliente}`;
      const cached = localStorage.getItem(key);
      if (cached) {
        try {
          const data = JSON.parse(cached);
          if (data && data.version) return data;
        } catch {}
      }

      const res = await fetch(url, { cache: 'no-cache' });
      if (!res.ok) throw new Error('No se pudo cargar tarifas');
      const data = await res.json();
      localStorage.setItem(key, JSON.stringify(data));
      return data;
    }

    function getTarifa(pricing, genero, edad) {
      const r = rangoDeEdad(edad);
      const fila = pricing.tarifas.find(t => t.rango === r);
      if (!fila) throw new Error('Rango no encontrado: ' + r);
      const val = genero === 'M' ? fila.M : fila.H;
      if (typeof val !== 'number') throw new Error('Tarifa inv√°lida en ' + r);
      const dec = pricing?.reglas?.redondeo ?? 2;
      return { rango: r, valor: Number(val.toFixed(dec)) };
    }

    function setParams(cliente, genero, edad) {
      const u = new URL(location);
      u.searchParams.set('cliente', cliente);
      u.searchParams.set('g', genero);
      u.searchParams.set('e', String(edad));
      history.replaceState(null, '', u);
    }

    async function recalc() {
      const cliente = $('#cliente').value;
      const genero  = $('#genero').value;
      const edad    = Number($('#edad').value) || 0;
      setParams(cliente, genero, edad);

      const pricing = await loadPricing(cliente).catch(err => {
        $('#cliente-hint').textContent = err.message + (cliente==='STRM' ? ' ‚Äî Llena pricing-strm.json' : '');
        $('#cliente-hint').classList.remove('hidden');
        throw err;
      });
      $('#cliente-hint').classList.add('hidden');

      // meta
      $('#meta').textContent = JSON.stringify({
        cliente: pricing.cliente,
        version: pricing.version,
        last_updated: pricing.last_updated,
        reglas: pricing.reglas
      }, null, 2);

      const { rango, valor } = getTarifa(pricing, genero, edad);
      const iva = valor * (pricing?.reglas?.iva ?? 0.16);
      const total = valor + iva;

      $('#rango').textContent = rango.replace('-', ' - ');
      $('#tarifa').textContent = formatMoney(valor);
      $('#iva').textContent = formatMoney(iva);
      $('#total').textContent = formatMoney(total);
    }

    // Init from URL
    (function init() {
      const u = new URL(location);
      const c = (u.searchParams.get('cliente') || 'BIMBO').toUpperCase();
      const g = (u.searchParams.get('g') || 'H').toUpperCase();
      const e = Number(u.searchParams.get('e') || '25');
      $('#cliente').value = c;
      $('#genero').value = g;
      $('#edad').value = e;
      ['change','input'].forEach(ev => {
        $('#cliente').addEventListener(ev, recalc);
        $('#genero').addEventListener(ev, recalc);
        $('#edad').addEventListener(ev, recalc);
      });
      recalc();
    })();

    // compartir
    $('#btn-compartir').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(location.href);
        alert('Enlace copiado al portapapeles');
      } catch { alert('No se pudo copiar el enlace'); }
    });
    // imprimir
    $('#btn-pdf').addEventListener('click', () => window.print());
  </script>
</body>
</html>
